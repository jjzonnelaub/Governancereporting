<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; background-color: #f8f9fa; }
      .container { max-width: 400px; margin: 0 auto; }
      h3 { color: #4a148c; font-weight: 500; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
      label { display: block; margin-top: 15px; font-weight: bold; color: #333; font-size: 14px; }
      input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-top: 5px; background: white;}
      .button-bar { display: flex; justify-content: flex-end; align-items: center; margin-top: 25px; }
      button { background-color: #673ab7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; transition: background-color 0.2s;}
      button:hover { background-color: #512da8; }
      button:disabled { background-color: #ccc; cursor: not-allowed; }
      #status { margin-top: 15px; color: #555; text-align: center; font-size: 14px; }
      .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #673ab7; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none;}
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        margin-top: 12px;
        overflow: hidden;
        display: none;
      }
      .progress-bar {
        height: 100%;
        background: #673ab7;
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s ease;
      }
      #progress-detail {
        font-size: 12px;
        color: #757575;
        margin-top: 8px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>Analyze Iteration Changelog</h3>
      
      <div>
        <label for="piNumber">1. Enter PI Number:</label>
        <input type="number" id="piNumber" placeholder="e.g., 13">
      </div>

      <div>
        <label for="iterationNumber">2. Select Iteration:</label>
        <select id="iterationNumber">
          <option value="">-- Select --</option>
          <option value="0">Iteration 0 (Pre-Planning) ðŸ“‹</option>
          <option value="1">Iteration 1</option>
          <option value="2">Iteration 2</option>
          <option value="3">Iteration 3</option>
          <option value="4">Iteration 4</option>
          <option value="5">Iteration 5</option>
          <option value="6">Iteration 6 (IP)</option>
        </select>
      </div>
      
      <div id="status"></div>
      <div id="spinner" class="spinner"></div>
      <div class="progress-bar-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div id="progress-detail"></div>
      
      <div class="button-bar">
        <button onclick="runAnalysis()" id="runBtn">Analyze Changes</button>
      </div>
    </div>
    
    <script>
      let pollCount = 0;
      let lastStatus = '';
      let isComplete = false;
      
      function runAnalysis() {
        const pi = document.getElementById('piNumber').value;
        const iter = document.getElementById('iterationNumber').value;

        if (!pi || !iter) {
          document.getElementById('status').innerText = 'Please enter a PI and select an iteration.';
          return;
        }

        // Disable button and show spinner
        document.getElementById('runBtn').disabled = true;
        document.getElementById('status').innerText = 'Starting analysis...';
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('progressBar').style.width = '0%';
        
        // Reset polling state
        pollCount = 0;
        lastStatus = '';
        isComplete = false;
        
        // Start adaptive polling after initial delay
        setTimeout(adaptivePoll, 2000);

        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onFailure)
          .runChangeAnalysis(parseInt(pi), parseInt(iter));
      }

      function adaptivePoll() {
        if (isComplete) return;
        
        pollCount++;
        
        google.script.run
          .withSuccessHandler(status => {
            if (status && status !== lastStatus) {
              updateStatus(status);
              lastStatus = status;
            }
            
            // Check for completion
            if (status && (status.includes('Complete') || status.includes('Error'))) {
              isComplete = true;
              return;
            }
            
            // Continue polling with adaptive intervals (matching other dialogs)
            if (!isComplete) {
              let nextInterval;
              if (pollCount < 5) {
                nextInterval = 3000;   // First 5 polls: every 3 seconds
              } else if (pollCount < 10) {
                nextInterval = 5000;   // Next 5 polls: every 5 seconds
              } else if (pollCount < 20) {
                nextInterval = 8000;   // Next 10 polls: every 8 seconds
              } else {
                nextInterval = 12000;  // After that: every 12 seconds
              }
              setTimeout(adaptivePoll, nextInterval);
            }
          })
          .withFailureHandler(() => {
            // On error, retry after 5 seconds
            if (!isComplete) {
              setTimeout(adaptivePoll, 5000);
            }
          })
          .getChangelogAnalysisStatus();
      }

      function updateStatus(status) {
        if (status) {
          const statusEl = document.getElementById('status');
          const progressBar = document.getElementById('progressBar');
          const progressDetail = document.getElementById('progress-detail');
          
          statusEl.innerText = status;
          
          // Parse progress from status messages
          if (status.includes('Fetching changelogs')) {
            // Extract progress like "Fetching changelogs (100/770)"
            const match = status.match(/\((\d+)\/(\d+)\)/);
            if (match) {
              const current = parseInt(match[1]);
              const total = parseInt(match[2]);
              const percent = Math.round((current / total) * 100);
              progressBar.style.width = percent + '%';
              progressDetail.textContent = `${current} of ${total} issues processed`;
            }
          } else if (status.includes('Writing changes')) {
            progressBar.style.width = '90%';
            progressDetail.textContent = 'Writing results to changelog...';
          } else if (status.includes('Complete')) {
            progressBar.style.width = '100%';
            progressDetail.textContent = 'Analysis complete!';
          }
        }
      }

      function onSuccess() {
        isComplete = true;
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('status').innerText = 'âœ… Analysis complete!';
        document.getElementById('progress-detail').textContent = '';
        document.getElementById('spinner').style.display = 'none';
        setTimeout(() => google.script.host.close(), 1500);
      }

      function onFailure(error) {
        isComplete = true;
        document.getElementById('status').innerText = 'Error: ' + error.message;
        document.getElementById('progress-detail').textContent = '';
        document.getElementById('runBtn').disabled = false;
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'none';
      }
    </script>
  </body>
</html>
